---
import Layout from '../../layouts/Layout.astro';

// Generate static paths for dynamic routes - generate more possible IDs
export function getStaticPaths() {
  // Generate IDs from 1 to 100 to cover possible post IDs
  return Array.from({ length: 100 }, (_, i) => ({
    params: { id: (i + 1).toString() }
  }));
}

const { id } = Astro.params;
---

<Layout>
  <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-8">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">Edit Post</h1>
    <!-- Loading state -->
    <div id="loading" class="text-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600 border-solid mx-auto mb-4"></div>
      <p class="text-gray-600">Loading post...</p>
    </div>
    <!-- Edit form -->
    <form id="editForm" class="space-y-6 hidden">
      <div>
        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
        <input 
          type="text" 
          id="title" 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Please enter post title"
          required
        />
      </div>
      <div>
        <label for="content" class="block text-sm font-medium text-gray-700 mb-1">Content</label>
        <textarea 
          rows={10} 
          id="content" 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Please enter post content"
          required
        ></textarea>
      </div>
      <div class="flex justify-end space-x-4">
        <button 
          type="button" 
          id="cancelBtn" 
          class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
        >
          Cancel
        </button>
        <button 
          type="submit" 
          class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        >
          Update
        </button>
      </div>
    </form>
    <!-- Error message -->
    <div id="error-message" class="mt-4 text-red-500 text-sm hidden"></div>
  </div>

  <script define:vars={{ id }}>
    // Fetch post data when page loads
    window.addEventListener('DOMContentLoaded', async () => {
      const loading = document.getElementById('loading');
      const editForm = document.getElementById('editForm');
      const errorMessage = document.getElementById('error-message');
      const titleInput = document.getElementById('title');
      const contentInput = document.getElementById('content');
      const cancelBtn = document.getElementById('cancelBtn');
      
      // Check if user is logged in
      const token = localStorage.getItem('token');
      if (!token) {
        // Redirect to login page if not logged in
        window.location.href = '/login';
        return;
      }
      
      try {
        // Call get post detail API
        const response = await fetch(`/api/posts/${id}`);
        const data = await response.json();
        
        if (data.success) {
          const post = data.data;
          
          // Remove permission check, allow all logged-in users to edit posts
          const currentUser = JSON.parse(localStorage.getItem('user'));
          
          // Fill form data
          titleInput.value = post.title;
          contentInput.value = post.content;
          
          // Show form, hide loading state
          loading.classList.add('hidden');
          editForm.classList.remove('hidden');
        } else {
          // Post not found
          loading.innerHTML = `
            <div class="text-center py-12">
              <h1 class="text-3xl font-bold text-gray-800 mb-4">404</h1>
              <p class="text-gray-600 mb-4">Post not found or has been deleted</p>
              <a href="/" class="text-blue-600 hover:text-blue-800 font-medium">Back to Home</a>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error fetching post details:', error);
        loading.innerHTML = `
          <div class="text-center py-12">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">500</h1>
            <p class="text-gray-600 mb-4">Failed to load post, please try again later</p>
            <a href="/" class="text-blue-600 hover:text-blue-800 font-medium">Back to Home</a>
          </div>
        `;
      }
      
      // Cancel button event
      cancelBtn.addEventListener('click', () => {
        // Return to post detail page
        window.location.href = `/posts/${id}`;
      });
      
      // Form submit event
      editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = titleInput.value;
        const content = contentInput.value;
        
        try {
          // Call update post API
          const response = await fetch(`/api/posts/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ title, content })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Update successful, redirect to post detail page
            window.location.href = `/posts/${id}`;
          } else {
            // Show error message
            errorMessage.textContent = data.message || 'Failed to update post, please try again';
            errorMessage.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Error updating post:', error);
          errorMessage.textContent = 'Network error, please try again later';
          errorMessage.classList.remove('hidden');
        }
      });
    });
  </script>
</Layout>