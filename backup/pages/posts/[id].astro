---
import Layout from '../../layouts/Layout.astro';

// Generate static paths for dynamic routes - generate more possible IDs
export function getStaticPaths() {
  // Generate IDs from 1 to 100 to cover more possible post IDs
  return Array.from({ length: 100 }, (_, i) => ({
    params: { id: (i + 1).toString() }
  }));
}

const { id } = Astro.params;
---

<Layout>
  <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-8">
    <!-- Post content area -->
    <div id="post-container">
      <!-- Loading state -->
      <div class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600 border-solid mx-auto mb-4"></div>
        <p class="text-gray-600">Loading post...</p>
      </div>
    </div>

    <!-- Comments area -->
    <section class="mt-12" id="comments-section">
      <!-- Comments content will be dynamically loaded via JavaScript -->
    </section>
  </div>

  <script define:vars={{ id }}>
    // Fetch post data when page loads
    window.addEventListener('DOMContentLoaded', async () => {
      const postContainer = document.getElementById('post-container');
      const commentsSection = document.getElementById('comments-section');
      
      try {
        // Call get post details API
        const response = await fetch(`/api/posts/${id}`);
        const data = await response.json();
        
        if (data.success) {
          const post = data.data;
          
          // Remove permission checks, allow everyone to edit and delete posts
          const currentUser = JSON.parse(localStorage.getItem('user'));
          const isLoggedIn = !!currentUser;
          
          // Render post content
          postContainer.innerHTML = `
            <article>
              <h1 class="text-3xl font-bold text-gray-800 mb-4">${post.title}</h1>
              <div class="text-sm text-gray-500 mb-6 flex items-center space-x-4">
                <span>Author: ${post.author_name}</span>
                <span>Published: ${new Date(post.created_at).toLocaleString()}</span>
                ${new Date(post.updated_at) > new Date(post.created_at) && (
                  `<span>Updated: ${new Date(post.updated_at).toLocaleString()}</span>`
                )}
              </div>
              <div class="text-gray-700 mb-8 whitespace-pre-line">${post.content}</div>
              <div class="flex space-x-4">
                <a href="/edit-post/${post.post_id}" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                  Edit
                </a>
                <button id="deleteBtn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">
                  Delete
                </button>
              </div>
            </article>
          `;
          
          // Add event listener for delete button, allow everyone to delete posts
          if (isLoggedIn) {
            const deleteBtn = document.getElementById('deleteBtn');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', async () => {
                // Confirmation prompt
                if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                  return;
                }
                
                try {
                  const token = localStorage.getItem('token');
                  
                  // Check if user is logged in
                  if (!token) {
                    alert('Please log in first');
                    window.location.href = '/login';
                    return;
                  }
                  
                  // Call delete API
                  const deleteResponse = await fetch(`/api/posts/${post.post_id}`, {
                    method: 'DELETE',
                    headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                    }
                  });
                  
                  const deleteData = await deleteResponse.json();
                  
                  if (deleteResponse.ok && deleteData.success) {
                    // Delete successful, redirect to homepage
                    window.location.href = '/';
                  } else {
                    // Show different error messages based on status codes
                    if (deleteResponse.status === 403) {
                      alert('You do not have permission to delete this post, only the author can delete it');
                    } else if (deleteResponse.status === 404) {
                      alert('Post does not exist or has been deleted');
                    } else {
                      alert(deleteData.message || 'Failed to delete post, please try again');
                    }
                  }
                } catch (error) {
                  console.error('Error deleting post:', error);
                  alert('Network error, please try again later. Error message: ' + error.message);
                }
              });
            }
          }
          
          // Get and display comments list
          const loadComments = async () => {
            try {
              const commentsResponse = await fetch(`/api/comments/post/${post.post_id}`);
              const commentsData = await commentsResponse.json();
              
              if (commentsData.success) {
                const comments = commentsData.data;
                
                if (comments.length === 0) {
                  commentsSection.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Comments (0)</h2>
                    <div class="text-center py-8 text-gray-600 mb-8">
                      <p>No comments yet, come and post the first one!</p>
                    </div>
                    
                    <form id="comment-form" class="mt-8 space-y-4">
                      <h3 class="text-xl font-semibold text-gray-800 mb-4">Add Comment</h3>
                      <div>
                        <textarea 
                          id="comment-content" 
                          rows={4} 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Write your comment..."
                          required
                        ></textarea>
                      </div>
                      <div>
                        <button 
                          type="submit" 
                          class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                        >
                          Submit Comment
                        </button>
                      </div>
                    </form>
                  `;
                } else {
                  commentsSection.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Comments (${comments.length})</h2>
                    <div class="space-y-6">
                      ${comments.map(comment => `
                        <div key="${comment.comment_id}" class="border-b border-gray-200 pb-4">
                          <div class="flex justify-between items-center mb-2">
                            <span class="font-medium text-gray-800">${comment.author_name}</span>
                            <div class="flex items-center space-x-3">
                              <span class="text-sm text-gray-500">${new Date(comment.created_at).toLocaleString()}</span>
                              <button class="delete-comment-btn text-red-500 hover:text-red-700 text-sm" data-comment-id="${comment.comment_id}">
                                Delete
                              </button>
                            </div>
                          </div>
                          <p class="text-gray-700">${comment.content}</p>
                        </div>
                      `).join('')}
                    </div>
                    
                    <form id="comment-form" class="mt-8 space-y-4">
                      <h3 class="text-xl font-semibold text-gray-800 mb-4">Add Comment</h3>
                      <div>
                        <textarea 
                          id="comment-content" 
                          rows={4} 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Write your comment..."
                          required
                        ></textarea>
                      </div>
                      <div>
                        <button 
                          type="submit" 
                          class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                        >
                          Submit Comment
                        </button>
                      </div>
                    </form>
                  `;
                }
                
                // Add submit event listener for comment form
                const commentForm = document.getElementById('comment-form');
                if (commentForm) {
                  commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const content = document.getElementById('comment-content').value.trim();
                    if (!content) {
                      return;
                    }
                    
                    try {
                      const token = localStorage.getItem('token');
                      
                      // Check if user is logged in
                      if (!token) {
                        alert('Please log in first to comment');
                        window.location.href = '/login';
                        return;
                      }
                      
                      // Submit comment
                      const submitResponse = await fetch('/api/comments/', {
                        method: 'POST',
                        headers: {
                          'Authorization': `Bearer ${token}`,
                          'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                          post_id: post.post_id,
                          content: content
                        })
                      });
                      
                      const submitData = await submitResponse.json();
                      
                      if (submitResponse.ok && submitData.success) {
                        // Comment successful, reload comments list
                        alert('Comment published successfully');
                        loadComments();
                      } else {
                        // Comment failed
                        alert(submitData.message || 'Failed to publish comment, please try again');
                      }
                    } catch (error) {
                      console.error('Error submitting comment:', error);
                      alert('Network error, please try again later');
                    }
                  });
                }
                
                // Add event listeners for all delete comment buttons
                const deleteCommentBtns = document.querySelectorAll('.delete-comment-btn');
                deleteCommentBtns.forEach(btn => {
                  btn.addEventListener('click', async () => {
                    // Confirmation prompt
                    if (!confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
                      return;
                    }
                    
                    try {
                      const token = localStorage.getItem('token');
                      const commentId = btn.getAttribute('data-comment-id');
                      
                      // Check if user is logged in
                      if (!token) {
                        alert('Please log in first to delete comments');
                        window.location.href = '/login';
                        return;
                      }
                      
                      // Call delete comment API
                      const deleteResponse = await fetch(`/api/comments/${commentId}`, {
                        method: 'DELETE',
                        headers: {
                          'Authorization': `Bearer ${token}`,
                          'Content-Type': 'application/json'
                        }
                      });
                      
                      const deleteData = await deleteResponse.json();
                      
                      if (deleteResponse.ok && deleteData.success) {
                        // Delete successful, reload comments list
                        alert('Comment deleted successfully');
                        loadComments();
                      } else {
                        // Delete failed
                        alert(deleteData.message || 'Failed to delete comment, please try again');
                      }
                    } catch (error) {
                      console.error('Error deleting comment:', error);
                      alert('Network error, please try again later');
                    }
                  });
                });
              } else {
                console.error('Failed to get comments:', commentsData.message);
                commentsSection.innerHTML = `
                  <h2 class="text-2xl font-bold text-gray-800 mb-6">Comments</h2>
                  <div class="text-center py-8 text-red-600 mb-8">
                    <p>Failed to load comments, please try again later</p>
                  </div>
                `;
              }
            } catch (error) {
              console.error('Error getting comments:', error);
              commentsSection.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Comments</h2>
                <div class="text-center py-8 text-red-600 mb-8">
                  <p>Network error, please try again later</p>
                </div>
              `;
            }
          };
          
          // Load comments list
          loadComments();
        } else {
          // Post not found
          postContainer.innerHTML = `
            <div class="text-center py-12">
              <h1 class="text-3xl font-bold text-gray-800 mb-4">404</h1>
              <p class="text-gray-600 mb-4">Post not found or has been deleted</p>
              <a href="/" class="text-blue-600 hover:text-blue-800 font-medium">Back to Homepage</a>
            </div>
          `;
          
          // Hide comments section
          commentsSection.style.display = 'none';
        }
      } catch (error) {
        console.error('Error getting post details:', error);
        postContainer.innerHTML = `
          <div class="text-center py-12">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">500</h1>
            <p class="text-gray-600 mb-4">Failed to load post, please try again later</p>
            <a href="/" class="text-blue-600 hover:text-blue-800 font-medium">Back to Homepage</a>
          </div>
        `;
        
        // Hide comments section
        commentsSection.style.display = 'none';
      }
    });
  </script>
</Layout>